<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>交易日志 · 稳定单页基座</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#0b0f14;--card:#121a24;--bd:#203040;--txt:#e6f0ff;--muted:#9bb0c9;--pri:#2bd576}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.6 system-ui,Segoe UI,Arial}
.header{position:sticky;top:0;background:#0c121b;border-bottom:1px solid var(--bd);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{background:#121a24;border:1px solid #203040;border-radius:12px;padding:16px;margin:12px 0}
.grid{display:grid;gap:10px}.two{grid-template-columns:repeat(2,1fr)}.four{grid-template-columns:repeat(4,1fr)}.six{grid-template-columns:repeat(6,1fr)}.full{grid-column:1/-1}
input,select,textarea,button{background:#0f1620;color:var(--txt);border:1px solid var(--bd);border-radius:10px;padding:10px 12px;outline:none}
button{cursor:pointer;font-weight:700}.btn{background:#172131}.primary{background:var(--pri);color:#081218;border:0}.ghost{background:transparent}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.muted{color:var(--muted)}.mt8{margin-top:8px}.mb8{margin-bottom:8px}
.nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:8px;border:1px solid var(--bd)}.nav a.active{background:#162030;color:#dff}
.table-wrap{overflow:auto;border:1px solid var(--bd);border-radius:12px}table{width:100%;border-collapse:collapse}th,td{padding:8px 10px;border-bottom:1px dashed #1f2b37;white-space:nowrap}
.hidden{display:none}
.badge{border:1px solid var(--bd);padding:2px 8px;border-radius:999px}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.kpi .box{background:#0f1620;border:1px solid var(--bd);border-radius:12px;padding:12px}
.toast{position:fixed;right:16px;bottom:16px;background:#0f1620;border:1px solid var(--bd);border-radius:10px;padding:10px 14px;z-index:99;max-width:72vw}
.toast.err{border-color:#5e2a2a;color:#ffcccc}

/* Light theme */
:root.light{--bg:#f6f8fb;--card:#ffffff;--bd:#dde3ee;--txt:#0b1420;--muted:#51617a;--pri:#1bd06a}
/* Shimmer skeleton */
.shimmer{position:relative;overflow:hidden;background:linear-gradient(90deg, rgba(255,255,255,0.06) 25%, rgba(255,255,255,0.12) 37%, rgba(255,255,255,0.06) 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
#banner{position:fixed;top:56px;left:0;right:0;margin:auto;max-width:820px;z-index:99}
#banner .msg{margin:8px 16px;background:#102030;border:1px solid var(--bd);border-left:4px solid #ff9a9a;border-radius:10px;padding:10px 12px}


code{background:#0f1620;border:1px solid var(--bd);padding:2px 6px;border-radius:6px}
button[disabled]{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
  <div class="header">
    <div><strong>交易日志 · 稳定单页基座</strong> <span id="userEmail" class="badge"></span></div>
    <div class="row nav"><span id="netdot" class="badge" style="margin-right:8px">• 在线</span><select id="themeToggle" class="ghost" style="padding:6px 8px;border-radius:8px;border:1px solid var(--bd)"><option value="dark">暗色</option><option value="light">亮色</option></select>
      <a href="#auth" id="nav_auth" class="active">登录</a>
      <a href="#dash" id="nav_dash">控制台</a>
      <a href="#plans" id="nav_plans">计划</a>
      <a href="#settings" id="nav_settings">设置</a>
      <a href="#config" id="nav_config">配置</a>
      <button id="logoutBtn" class="btn ghost">退出</button>
    </div>
  </div>
  <div id="banner"></div>
  <div class="wrap">
    <!-- 登录 -->
    <section id="view_auth" class="card">
      <h2>登录 / 注册</h2>
      <div class="grid two">
        <input id="email" placeholder="邮箱">
        <input id="pwd" type="password" placeholder="密码（≥6 位）">
      </div>
      <div class="row mt8">
        <button id="loginBtn" class="btn primary">登录</button>
        <button id="signupBtn" class="btn">注册</button>
        <span id="authMsg" class="muted"></span>
      </div>
    </section>

    <!-- 控制台 -->
    <section id="view_dash" class="card hidden">
      <h2>新增交易</h2>
      <div class="grid four">
        <select id="side"><option value="BUY">买入</option><option value="SELL">卖出</option></select>
        <input id="symbol" placeholder="标的（BTCUSDT/AAPL）">
        <input id="qty" type="number" step="0.00000001" placeholder="数量">
        <input id="price" type="number" step="0.00000001" placeholder="价格">
        <input id="fee" type="number" step="0.00000001" placeholder="手续费">
        <input id="exchange" placeholder="交易所（可选）">
        <input id="strategy" placeholder="策略（可选）">
        <input id="account" placeholder="账户（可选）">
        <input id="tags" class="full" placeholder="标签（逗号分隔，可选）">
        <input id="ts" type="datetime-local" class="full">
        <input id="receipt" type="file" accept=".png,.jpg,.jpeg" class="full">
      </div>
      <textarea id="notes" class="full mt8" placeholder="备注（可选）"></textarea>
      <div class="row mt8">
        <button id="saveBtn" class="btn primary">保存记录</button>
        <span id="saveMsg" class="muted"></span>
      </div>

      <h3 class="mt8">筛选</h3>
      <div class="grid six">
        <input id="filter_symbol" placeholder="标的（模糊）">
        <select id="filter_side"><option value="">方向（全部）</option><option value="BUY">买入</option><option value="SELL">卖出</option></select>
        <input id="filter_date" type="date">
        <button id="refreshBtn" class="btn">刷新</button>
        <button id="cleanFilter" class="btn ghost">清空</button>
        <button id="exportCsv" class="btn ghost">导出 CSV</button><button id="loadMore" class="btn ghost">加载更多</button>
        <label class="btn ghost">导入 CSV<input type="file" id="importCsv" accept=".csv" hidden></label>
      </div>

      <div class="table-wrap mt8">
        <table id="txTable">
          <thead><tr>
            <th>时间</th><th>方向</th><th>标的</th><th>数量</th><th>价格</th><th>手续费</th>
            <th>交易所</th><th>策略</th><th>账户</th><th>标签</th><th>凭证</th><th>备注</th><th>操作</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="pnlStatus" class="muted mt8"></div>

      <div class="card mt8">
        <h3>统计分析</h3>
        <div class="kpi">
          <div class="box"><div class="muted">记录数</div><div id="k_total" style="font-weight:800;font-size:18px">0</div></div>
          <div class="box"><div class="muted">买入数</div><div id="k_buy">0</div></div>
          <div class="box"><div class="muted">卖出数</div><div id="k_sell">0</div></div>
          <div class="box"><div class="muted">手续费合计</div><div id="k_fee">0</div></div>
        </div>
        <div class="grid two mt8">
          <div><h4>按标的 Top5</h4><div id="topSymbols" class="muted"></div></div>
          <div><h4>最近 7 天记录数</h4><div id="last7" class="muted"></div></div>
        </div>
      </div>
    </section>

    <!-- 计划 -->
    <section id="view_plans" class="card hidden">
      <h2>新建计划</h2>
      <div class="grid four">
        <input id="p_symbol" placeholder="标的（BTCUSDT/AAPL）">
        <input id="p_side" placeholder="方向（做多/做空/现货）">
        <input id="p_entry" type="number" step="0.00000001" placeholder="计划入场价">
        <input id="p_leverage" type="number" step="1" placeholder="杠杆（可选）">
        <input id="p_stop" type="number" step="0.00000001" placeholder="止损价（可选）">
        <input id="p_take" type="number" step="0.00000001" placeholder="止盈价（可选）">
        <input id="p_size" type="number" step="0.00000001" placeholder="计划仓位（可选）">
        <input id="p_time" type="datetime-local" placeholder="计划执行时间（可选）">
      </div>
      <textarea id="p_logic" class="full mt8" placeholder="开仓逻辑 / 备注"></textarea>
      <div class="row mt8">
        <button id="p_save" class="btn primary">保存计划</button>
        <span id="p_msg" class="muted"></span>
      </div>

      <div class="table-wrap mt8">
        <table id="planTable">
          <thead><tr><th>时间</th><th>标的</th><th>方向</th><th>入场</th><th>止损</th><th>止盈</th><th>杠杆</th><th>仓位</th><th>逻辑</th><th>状态</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 设置 -->
    <section id="view_settings" class="card hidden">
      <h2>个性化设置</h2>
      <div class="grid two">
        <select id="theme">
          <option value="dark">暗色主题</option>
          <option value="light">亮色主题</option>
        </select>
        <input id="tz" placeholder="时区（例如 Asia/Shanghai）">
      </div>
      <div class="row mt8">
        <button id="s_save" class="btn primary">保存设置</button>
        <span id="s_msg" class="muted"></span>
      </div>
    </section>

    <!-- 配置 -->
    <section id="view_config" class="card hidden">
      <h2>项目配置</h2>
      <div class="grid two">
        <input id="cfg_url" placeholder="Project URL (https://xxxx.supabase.co)">
        <input id="cfg_key" placeholder="anon 公钥 (eyJ...)">
      </div>
      <div class="row mt8">
        <button id="cfg_save" class="btn primary">保存/测试</button>
        <span id="cfg_msg" class="muted"></span>
      </div>
    
  <section class="card" id="healthBox" class="hidden">
    <h2>一键自检（Auth + 表权限 + 写入）</h2>
    <div class="row">
      <button id="hc_run" class="btn primary">开始自检</button>
      <span id="hc_msg" class="muted"></span>
    </div>
    <div class="muted mt8">
      若提示 RLS/权限错误：请在 Supabase → SQL Editor 依次运行<br>
      <code>ensure_transactions.sql</code>、<code>ensure_plans.sql</code>、<code>ensure_profiles.sql</code>，
      如需上传凭证，先创建 <code>receipts</code> 桶，再运行 <code>storage_policies.sql</code>。
    </div>
  </section>
</section>
  </div>

<script>
// === 配置（已内置你的项目，亦可在“配置”页覆盖） ===
const URL_DEFAULT = "https://wbvwdqgkgopjqmxeibrf.supabase.co";
const KEY_DEFAULT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndidndkcWdrZ29wanFteGVpYnJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTc4NDEsImV4cCI6MjA3MDMzMzg0MX0.1xotlETbjPA5U8Hn8i0tt79J_djr9Fkldk9kSPSdxa8";

const $ = (id)=>document.getElementById(id);
const toast = (msg,err=false)=>{ const d=document.createElement('div'); d.className='toast'+(err?' err':''); d.textContent=msg; document.body.appendChild(d); setTimeout(()=>d.remove(),2600); };
const parseNum = (v)=>{ if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null; };
const toISO = (v)=>{ if(!v) return null; const d=new Date(v); return isNaN(d)?null:d.toISOString(); };
const fmt = (n)=> (n==null||Number.isNaN(n))?'':Number(n).toFixed(4);

function formatByTZ(iso){
  try{
    const tz = localStorage.getItem('profile_tz') || '';
    return new Date(iso).toLocaleString(undefined, tz? { timeZone: tz } : undefined);
  }catch{return new Date(iso).toLocaleString();}
}

// Theme
(function(){ try{ const th = localStorage.getItem('theme') || 'dark'; if(th==='light'){ document.documentElement.classList.add('light'); } }catch{} })();

function setTheme(v){ try{ localStorage.setItem('theme', v); if(v==='light'){ document.documentElement.classList.add('light'); } else { document.documentElement.classList.remove('light'); } }catch{} }
const themeSel = document.getElementById('themeToggle'); if(themeSel){ themeSel.value = (localStorage.getItem('theme')||'dark'); themeSel.onchange = ()=> setTheme(themeSel.value); }

// Online indicator
function updateNet(){ const dot = document.getElementById('netdot'); if(!dot) return; if(navigator.onLine){ dot.textContent='• 在线'; dot.style.color='#2bd576'; } else { dot.textContent='• 离线'; dot.style.color='#ff6b6b'; } }
window.addEventListener('online', updateNet); window.addEventListener('offline', updateNet); updateNet();

// Global banner
function showBanner(text){ const b=document.getElementById('banner'); if(!b) return; const m=document.createElement('div'); m.className='msg'; m.textContent=text; b.appendChild(m); setTimeout(()=>m.remove(), 4000); }

// Debounce
function debounce(fn,wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),wait); }; }

// Ctrl+S to save
document.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); const sbt=document.getElementById('saveBtn'); if(sbt && !sbt.disabled) sbt.click(); }});


function getCfg(){ return { url:localStorage.getItem('sp_url')||URL_DEFAULT, key:localStorage.getItem('sp_key')||KEY_DEFAULT }; }
function setCfg(u,k){ if(u) localStorage.setItem('sp_url',u); if(k) localStorage.setItem('sp_key',k); }
function client(){ const c=getCfg(); return window.supabase.createClient(c.url, c.key); }

let sb,user; let PAGE_LIMIT=50, pageOffset=0;

// 导航显示隐藏
function show(hash){
  document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
  document.querySelectorAll('[id^="view_"]').forEach(v=>v.classList.add('hidden'));
  const id=(hash||'#auth').replace('#','');
  const nav=document.getElementById('nav_'+id); if(nav) nav.classList.add('active');
  const view=document.getElementById('view_'+id); if(view) view.classList.remove('hidden');
}
addEventListener('hashchange', ()=> show(location.hash));

(async function init(){
  sb = client();
  // 事件绑定
  $('loginBtn').onclick=onLogin; $('signupBtn').onclick=onSignup; $('logoutBtn').onclick=async()=>{ await sb.auth.signOut(); user=null; location.hash='#auth'; show(); };
  $('saveBtn').onclick=onSave; $('refreshBtn').onclick=loadTable; $('cleanFilter').onclick=()=>{ $('filter_symbol').value=''; $('filter_side').value=''; $('filter_date').value=''; loadTable(); };
  $('exportCsv').onclick=exportCsv; $('importCsv').onchange=importCsv; document.getElementById('loadMore').onclick=()=>{ pageOffset+=PAGE_LIMIT; loadTable(true); }; const deb=debounce(()=>{ pageOffset=0; loadTable(); }, 300); document.getElementById('filter_symbol').addEventListener('input', deb); document.getElementById('filter_side').addEventListener('change', ()=>{ pageOffset=0; loadTable(); }); document.getElementById('filter_date').addEventListener('change', ()=>{ pageOffset=0; loadTable(); });
  $('p_save').onclick=onSavePlan;
  $('s_save').onclick=onSaveSettings;
  $('cfg_save').onclick=onSaveCfg;

  // 自动草稿
  document.querySelectorAll('#view_dash input,#view_dash textarea,#view_dash select').forEach(el=>{ el.addEventListener('input',saveDraft); el.addEventListener('change',saveDraft); });
  restoreDraft(); bindValidation();

  // 尝试登录态
  try{ const { data:{ session } } = await sb.auth.getSession(); if(session?.user){ onLoggedIn(session.user); } }catch{}
  show(location.hash||'#auth');
})();

async function onLogin(){
  $('loginBtn').disabled=true; $('authMsg').textContent='登录中…';
  try{
    const { error } = await sb.auth.signInWithPassword({ email:$('email').value.trim(), password:$('pwd').value });
    if(error) throw error;
    const { data:{ user } } = await sb.auth.getUser(); onLoggedIn(user);
  }catch(e){ $('authMsg').textContent='登录失败：'+e.message; }
  finally{ $('loginBtn').disabled=false; }
}
async function onSignup(){
  $('signupBtn').disabled=true; $('authMsg').textContent='注册中…';
  try{
    const { error } = await sb.auth.signUp({ email:$('email').value.trim(), password:$('pwd').value });
    if(error) throw error; $('authMsg').textContent='注册成功，请到邮箱确认后再登录';
  }catch(e){ $('authMsg').textContent='注册失败：'+e.message; }
  finally{ $('signupBtn').disabled=false; }
}
function onLoggedIn(u){
  user=u; document.getElementById('userEmail').textContent = u.email||''; location.hash='#dash'; show('#dash'); pageOffset=0; loadTable(); loadSettings();
}

// 草稿
function saveDraft(){
  const o={ side:$('side').value, symbol:$('symbol').value, qty:$('qty').value, price:$('price').value, fee:$('fee').value, exchange:$('exchange').value, strategy:$('strategy').value, account:$('account').value, tags:$('tags').value, ts:$('ts').value, notes:$('notes').value };
  localStorage.setItem('draft_tx', JSON.stringify(o));
}
function restoreDraft(){
  const s=localStorage.getItem('draft_tx'); if(!s) return; try{ const o=JSON.parse(s); ['side','symbol','qty','price','fee','exchange','strategy','account','tags','ts','notes'].forEach(id=>{ if(o[id]!=null) $(id).value=o[id]; }); }catch{}
}

// 保存交易
async function onSave(){
  const btn=$('saveBtn'); btn.disabled=true; $('saveMsg').textContent='保存中…';
  try{
    if(!user){ toast('未登录',true); return; }
    const payload={
      user_id:user.id, ts: toISO($('ts').value) || new Date().toISOString(),
      symbol:$('symbol').value.trim(), side:$('side').value,
      qty:parseNum($('qty').value), price:parseNum($('price').value), fee:parseNum($('fee').value)||0,
      exchange:$('exchange').value.trim()||null, strategy:$('strategy').value.trim()||null, account:$('account').value.trim()||null,
      tags: ($('tags').value.trim()? $('tags').value.split(/[,，\s]+/).filter(Boolean): []),
      notes:$('notes').value.trim()||null, attachment_url:null
    };
    if(!payload.symbol || !payload.qty || !payload.price || !payload.ts){ toast('请填写：标的 / 数量 / 价格 / 时间',true); return; }

    const file=$('receipt').files[0];
    if(file){
      const path = `${user.id}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
      const up = await sb.storage.from('receipts').upload(path, file, { upsert:false });
      if(up.error){ toast('凭证上传失败：'+up.error.message,true); }
      else { const { data } = sb.storage.from('receipts').getPublicUrl(path); payload.attachment_url=data.publicUrl; }
    }

    const { error } = await sb.from('transactions').insert(payload);
    if(error) throw error;
    $('saveMsg').textContent='✅ 已保存'; $('qty').value=''; $('price').value=''; $('fee').value=''; $('notes').value='';
    loadTable();
  }catch(e){ toast('保存失败：'+e.message,true); showBanner('保存失败：'+e.message); }
  finally{ btn.disabled=false; setTimeout(()=> $('saveMsg').textContent='', 1500); }
}

// 读取表格 + 统计
async function loadTable(append=false){
  const tbody=document.querySelector('#txTable tbody'); if(!append){ if(!append){ tbody.innerHTML=''; } for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="13" class="shimmer">&nbsp;</td>'; tbody.appendChild(tr);} }
  try{
    let q = sb.from('transactions').select('*').eq('user_id', user.id).order('ts',{ascending:false}).range(pageOffset, pageOffset+PAGE_LIMIT-1);
    const fs=$('filter_symbol').value.trim(); if(fs) q=q.ilike('symbol', `%${fs}%`);
    const fside=$('filter_side').value; if(fside) q=q.eq('side', fside);
    const fd=$('filter_date').value; if(fd){ const s=new Date(fd); const e=new Date(s); e.setDate(s.getDate()+1); q=q.gte('ts', s.toISOString()).lt('ts', e.toISOString()); }
    const { data:rows, error } = await q; if(error) throw error;
    if(!append){ tbody.innerHTML=''; }

    let cntBuy=0,cntSell=0,sumFee=0; const symCount=new Map(); const last7=new Array(7).fill(0);
    const today=new Date(); today.setHours(0,0,0,0);
    for(const r of rows){
      if(r.side==='BUY') cntBuy++; else if(r.side==='SELL') cntSell++;
      sumFee += Number(r.fee||0); symCount.set(r.symbol, (symCount.get(r.symbol)||0)+1);
      const d=new Date(r.ts); d.setHours(0,0,0,0); const diff=Math.floor((today-d)/(24*3600*1000)); if(diff>=0&&diff<7) last7[6-diff]++;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${formatByTZ(r.ts)}</td>
        <td>${r.side}</td>
        <td>${r.symbol}</td>
        <td>${(r.qty==null)?'':Number(r.qty).toFixed(4)}</td>
        <td>${(r.price==null)?'':Number(r.price).toFixed(4)}</td>
        <td>${(r.fee==null)?'':Number(r.fee).toFixed(4)}</td>
        <td>${r.exchange||''}</td>
        <td>${r.strategy||''}</td>
        <td>${r.account||''}</td>
        <td>${(r.tags||[]).join(' ')}</td>
        <td>${r.attachment_url? `<a href="${r.attachment_url}" target="_blank">图片</a>`:''}</td>
        <td>${r.notes||''}</td>
        <td><button class="btn ghost" data-id="${r.id}">删除</button></td>`;
      tbody.appendChild(tr);
    }
    document.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.onclick = async ()=>{ if(!confirm('确定删除？')) return; const id=btn.getAttribute('data-id'); const { error } = await sb.from('transactions').delete().eq('id', id); if(error) toast('删除失败：'+error.message,true); else loadTable(); };
    });
    document.getElementById('pnlStatus').textContent = `共 ${rows.length} 条 | BUY ${cntBuy} · SELL ${cntSell}`;
    document.getElementById('k_total').textContent = rows.length;
    document.getElementById('k_buy').textContent = cntBuy;
    document.getElementById('k_sell').textContent = cntSell;
    document.getElementById('k_fee').textContent = (sumFee).toFixed(4);
    const top=[...symCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([s,c])=>`${s}: ${c}`).join(' | ')||'—';
    document.getElementById('topSymbols').textContent = top;
    document.getElementById('last7').textContent = last7.join(' , ');
    document.getElementById('loadMore').style.display = (rows.length===PAGE_LIMIT)?'inline-flex':'none';
  }catch(e){ tbody.innerHTML = `<tr><td colspan="13">读取失败：${e.message}</td></tr>`; showBanner('读取失败：'+e.message); }
}

// 导出/导入
async function exportCsv(){
  const { data:rows, error } = await sb.from('transactions').select('*').eq('user_id', user.id).order('ts',{ascending:false}).limit(5000);
  if(error){ toast('导出失败：'+error.message,true); return; }
  const header=['id','ts','side','symbol','qty','price','fee','exchange','strategy','account','tags','attachment_url','notes'];
  const csv=[header.join(',')].concat(rows.map(r=> header.map(k=> JSON.stringify(r[k]??'')).join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='transactions.csv'; a.click();
}
async function importCsv(e){
  const file=e.target.files[0]; if(!file) return;
  try{
    const text=await file.text(); const lines=text.split(/\r?\n/).filter(Boolean); const header=lines.shift().split(',');
    const rowsAll = lines.map(line=>{ const cells=line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[]; const obj={}; header.forEach((h,i)=>{ try{ obj[h]=JSON.parse(cells[i]??'""'); }catch{ obj[h]=cells[i]??''; } }); obj.user_id=user.id; return obj; });
    let ok=0; for(let i=0;i<rowsAll.length;i+=200){ const chunk=rowsAll.slice(i,i+200); const { error } = await sb.from('transactions').insert(chunk); if(error){ toast('导入失败：'+error.message,true); break; } ok+=chunk.length; }
    if(ok>0){ toast('导入成功 '+ok+' 条'); loadTable(); }
  }catch(err){ toast('导入异常：'+err.message,true); } finally{ e.target.value=''; }
}

// 计划
async function onSavePlan(){
  if(!user){ toast('未登录',true); return; }
  const row={ user_id:user.id, symbol:$('p_symbol').value.trim(), side:$('p_side').value.trim()||null,
    entry:parseNum($('p_entry').value), stop:parseNum($('p_stop').value), take:parseNum($('p_take').value),
    leverage:parseNum($('p_leverage').value), size:parseNum($('p_size').value),
    plan_time:toISO($('p_time').value), logic:$('p_logic').value.trim()||null, status:'open' };
  if(!row.symbol){ toast('请填写标的',true); return; }
  const { error } = await sb.from('plans').insert(row); if(error) toast('保存失败：'+error.message,true); else { toast('✅ 已保存'); loadPlans(); }
}
async function loadPlans(){
  const tb=document.querySelector('#planTable tbody'); if(!tb) return;
  tb.innerHTML='<tr><td colspan="11">加载中…</td></tr>';
  const { data, error } = await sb.from('plans').select('*').eq('user_id', user.id).order('created_at',{ascending:false});
  if(error){ tb.innerHTML='<tr><td colspan="11">读取失败：'+error.message+'</td></tr>'; return; }
  tb.innerHTML='';
  for(const r of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.plan_time? new Date(r.plan_time).toLocaleString() : ''}</td>
      <td>${r.symbol||''}</td><td>${r.side||''}</td><td>${r.entry??''}</td><td>${r.stop??''}</td><td>${r.take??''}</td>
      <td>${r.leverage??''}</td><td>${r.size??''}</td><td>${r.logic||''}</td><td>${r.status||''}</td>
      <td><button class="btn ghost" data-id="${r.id}" data-act="done">完成</button>
          <button class="btn ghost" data-id="${r.id}" data-act="del">删除</button></td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick=async()=>{
      const id=b.getAttribute('data-id'), act=b.getAttribute('data-act');
      if(act==='done'){ const { error } = await sb.from('plans').update({status:'done'}).eq('id', id); if(error) toast('失败：'+error.message,true); else loadPlans(); }
      if(act==='del'){ if(!confirm('确定删除？')) return; const { error } = await sb.from('plans').delete().eq('id', id); if(error) toast('失败：'+error.message,true); else loadPlans(); }
    };
  });
}

// 设置
async function loadSettings(){
  const { data } = await sb.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
  if(data){ $('theme').value=data.theme||'dark'; $('tz').value=data.timezone||''; }
}
async function onSaveSettings(){
  const row={ user_id:user.id, theme:$('theme').value, timezone:$('tz').value };
  const { error } = await sb.from('profiles').upsert(row).eq('user_id', user.id);
  $('s_msg').textContent = error ? ('保存失败：'+error.message) : '✅ 已保存'; if(!error){ try{ localStorage.setItem('profile_tz', $('tz').value||''); }catch{} }
}

// 配置
async function onSaveCfg(){
  const u=$('cfg_url').value.trim(), k=$('cfg_key').value.trim(); if(!u||!k){ $('cfg_msg').textContent='请填写 URL 和 KEY'; return; }
  setCfg(u,k); $('cfg_msg').textContent='已保存，测试连接…';
  try{ const { error } = await client().from('transactions').select('*').limit(1); if(error) throw error; $('cfg_msg').textContent='✅ 连接成功'; }
  catch(e){ $('cfg_msg').textContent='❌ 连接失败：'+e.message; }
}


function isValidForm(){
  const ok = Boolean($('#symbol').value.trim())
    && parseNum($('#qty').value) > 0
    && parseNum($('#price').value) > 0
    && Boolean($('#ts').value);
  return ok;
}
function bindValidation(){
  const f = ['symbol','qty','price','ts'];
  const handler = ()=>{ $('#saveBtn').disabled = !isValidForm(); };
  f.forEach(id=>{ const el=$('#'+id); if(el){ el.addEventListener('input', handler); el.addEventListener('change', handler); } });
  handler();
}

// 初始化配置页默认值
addEventListener('load', ()=>{ $('cfg_url').value = getCfg().url; $('cfg_key').value = getCfg().key; });

// Health-check
document.addEventListener('DOMContentLoaded', ()=>{
  const hc = document.getElementById('hc_run');
  if(hc){ hc.onclick = runHealthCheck; }
});
async function runHealthCheck(){
  const msg = document.getElementById('hc_msg'); msg.textContent='自检中…';
  let sb=null; try{ sb = client(); }catch(e){ msg.textContent='❌ 配置无效：'+e.message; return; }

  // 1) Auth check
  try{
    const { data:{ session }, error } = await sb.auth.getSession();
    if(error) throw error;
    if(!session){ msg.textContent='⚠️ 未登录：请先在“登录”页登录再来'; return; }
  }catch(e){ msg.textContent='❌ Auth 检查失败：'+e.message; return; }

  // 2) Select permission
  try{
    const { error } = await sb.from('transactions').select('*').limit(1);
    if(error) throw error;
  }catch(e){ msg.textContent='❌ 读取失败：'+e.message+' — 请运行 ensure_transactions.sql'; return; }

  // 3) Insert + delete dummy
  try{
    const { data:{ user } } = await sb.auth.getUser();
    const dummy = { user_id:user.id, ts:new Date().toISOString(), symbol:'__HEALTH__', side:'BUY', qty:1, price:1, fee:0, tags:[] };
    const ins = await sb.from('transactions').insert(dummy);
    if(ins.error) throw ins.error;
    const { data:got } = await sb.from('transactions').select('id').eq('symbol','__HEALTH__').order('ts',{ascending:false}).limit(1);
    if(got && got[0]){ await sb.from('transactions').delete().eq('id', got[0].id); }
  }catch(e){ msg.textContent='❌ 写入失败：'+e.message+' — 多半是 RLS 或表未建'; return; }

  msg.textContent='✅ 一切正常，可以使用';
}

</script>
</body>
</html>
