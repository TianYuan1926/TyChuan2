<!doctype html><html lang="zh-CN"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>交易日志 · 稳定基座 v3</title>
<link rel="stylesheet" href="styles.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
</head><body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div><strong>交易日志 · 稳定基座 v3</strong></div>
      <div class="row">
        <a class="secondary" href="config.html">配置</a>
        <button id="logoutBtn" class="secondary">退出</button>
      </div>
    </div>
    <div class="muted" id="userInfo"></div>
  </div>

  <div class="card" id="authBox">
    <h2>登录 / 注册</h2>
    <div class="grid" style="grid-template-columns:repeat(2,1fr)">
      <input id="email" placeholder="邮箱">
      <input id="pwd" type="password" placeholder="密码（≥6 位）">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="loginBtn" class="primary">登录</button>
      <button id="signupBtn" class="secondary">注册</button>
      <span id="authMsg" class="muted"></span>
    </div>
  </div>

  <div class="card" id="formBox" style="display:none">
    <h2>新增交易</h2>
    <div class="grid">
      <select id="side"><option value="BUY">买入</option><option value="SELL">卖出</option></select>
      <input id="symbol" placeholder="标的（BTCUSDT/AAPL）">
      <input id="qty" type="number" step="0.00000001" placeholder="数量">
      <input id="price" type="number" step="0.00000001" placeholder="价格">
      <input id="fee" type="number" step="0.00000001" placeholder="手续费">
      <input id="exchange" placeholder="交易所（可选）">
      <input id="strategy" placeholder="策略（可选）">
      <input id="account" placeholder="账户（可选）">
      <input id="tags" class="full" placeholder="标签（逗号分隔，可选）">
      <input id="ts" type="datetime-local" class="full">
    </div>
    <textarea id="notes" class="full" placeholder="备注（可选）" style="margin-top:8px"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="primary">保存记录</button>
      <span id="saveMsg" class="muted"></span>
    </div>
  </div>

  <div class="card" id="listBox" style="display:none">
    <h2>交易记录</h2>
    <div class="row" style="margin-bottom:8px">
      <input id="filter_symbol" placeholder="标的（模糊）">
      <select id="filter_side"><option value="">方向（全部）</option><option value="BUY">买入</option><option value="SELL">卖出</option></select>
      <input id="filter_date" type="date">
      <button id="filterBtn" class="secondary">筛选</button>
      <button id="clearBtn" class="secondary">清空</button>
    </div>
    <div class="table-wrap">
      <table id="txTable">
        <thead>
          <tr><th>时间</th><th>方向</th><th>标的</th><th>数量</th><th>价格</th><th>手续费</th><th>交易所</th><th>策略</th><th>账户</th><th>标签</th><th>备注</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="pnl" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2200); }
function parseNum(v){ if(v===''||v===null||v===undefined) return null; const n=Number(v); return Number.isFinite(n)?n:null; }
function toISO(v){ if(!v) return null; const d=new Date(v); return isNaN(d)?null:d.toISOString(); }
function fmt(n){ return (n===null||n===undefined||Number.isNaN(n))?'':Number(n).toFixed(4); }

let sb, currentUser;

(async function init(){
  try{ sb = sbConfig.getSupabase(); }catch(e){ return; } // 未配置会跳 config.html
  const u = await sbConfig.requireAuth(); if(u){ onLogin(u); }
  $('loginBtn').onclick = async ()=>{
    $('loginBtn').disabled=true; $('authMsg').textContent='登录中…';
    try{
      const { error } = await sb.auth.signInWithPassword({ email: $('email').value.trim(), password: $('pwd').value });
      if(error) throw error;
      const { data:{ user } } = await sb.auth.getUser(); onLogin(user);
    }catch(e){ toast('登录失败：'+e.message); }
    finally{ $('loginBtn').disabled=false; $('authMsg').textContent=''; }
  };
  $('signupBtn').onclick = async ()=>{
    $('signupBtn').disabled=true; $('authMsg').textContent='注册中…';
    try{
      const { error } = await sb.auth.signUp({ email: $('email').value.trim(), password: $('pwd').value });
      if(error) throw error;
      toast('注册成功，请到邮箱确认后再登录');
    }catch(e){ toast('注册失败：'+e.message); }
    finally{ $('signupBtn').disabled=false; $('authMsg').textContent=''; }
  };
  $('logoutBtn').onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };
  $('saveBtn').onclick = onSave;
  $('filterBtn').onclick = loadTable;
  $('clearBtn').onclick = ()=>{ $('filter_symbol').value=''; $('filter_side').value=''; $('filter_date').value=''; loadTable(); };
})();

function onLogin(user){
  currentUser = user;
  $('userInfo').textContent = '已登录：' + (user?.email||'');
  $('authBox').style.display='none';
  $('formBox').style.display='';
  $('listBox').style.display='';
  loadTable();
}

async function onSave(){
  const btn=$('saveBtn'); btn.disabled=true; $('saveMsg').textContent='保存中…';
  try{
    if(!currentUser){ toast('登录失效'); return; }
    const payload={
      user_id: currentUser.id,
      ts: toISO($('ts').value) || new Date().toISOString(),
      symbol: $('symbol').value.trim(),
      side: $('side').value,
      qty: parseNum($('qty').value),
      price: parseNum($('price').value),
      fee: parseNum($('fee').value)||0,
      exchange: $('exchange').value.trim()||null,
      strategy: $('strategy').value.trim()||null,
      account: $('account').value.trim()||null,
      tags: ($('tags').value.trim()? $('tags').value.split(/[,，\s]+/).filter(Boolean): []),
      notes: $('notes').value.trim()||null
    };
    if(!payload.symbol || !payload.qty || !payload.price || !payload.ts){ toast('请填写：标的 / 数量 / 价格 / 时间'); return; }
    const { error } = await sb.from('transactions').insert(payload);
    if(error) throw error;
    $('saveMsg').textContent='✅ 已保存'; $('qty').value=''; $('price').value=''; $('fee').value=''; $('notes').value=''; loadTable();
  }catch(e){ toast('保存失败：'+e.message); }
  finally{ btn.disabled=false; setTimeout(()=>$('saveMsg').textContent='',1500); }
}

async function loadTable(){
  const tbody=document.querySelector('#txTable tbody'); tbody.innerHTML='<tr><td colspan="12">加载中…</td></tr>';
  try{
    let q = sb.from('transactions').select('*').eq('user_id', currentUser.id).order('ts',{ascending:false}).limit(300);
    const fs=$('filter_symbol').value.trim(); if(fs) q=q.ilike('symbol', `%${fs}%`);
    const fside=$('filter_side').value; if(fside) q=q.eq('side', fside);
    const fd=$('filter_date').value; if(fd){ const s=new Date(fd); const e=new Date(s); e.setDate(s.getDate()+1); q=q.gte('ts', s.toISOString()).lt('ts', e.toISOString()); }
    const { data:rows, error } = await q;
    if(error) throw error;
    tbody.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(r.ts).toLocaleString()}</td>
        <td>${r.side}</td>
        <td>${r.symbol}</td>
        <td>${fmt(r.qty)}</td>
        <td>${fmt(r.price)}</td>
        <td>${fmt(r.fee)}</td>
        <td>${r.exchange||''}</td>
        <td>${r.strategy||''}</td>
        <td>${r.account||''}</td>
        <td>${(r.tags||[]).join(' ')}</td>
        <td>${r.notes||''}</td>
        <td><button class="secondary" data-id="${r.id}">删除</button></td>`;
      tbody.appendChild(tr);
    }
    document.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.onclick = async ()=>{
        if(!confirm('确定删除？')) return;
        const id=btn.getAttribute('data-id');
        const { error } = await sb.from('transactions').delete().eq('id', id);
        if(error) toast('删除失败：'+error.message); else loadTable();
      };
    });
  }catch(e){ tbody.innerHTML = `<tr><td colspan="12">读取失败：${e.message}</td></tr>`; }
}
</script>
</body></html>
